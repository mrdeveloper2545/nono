{% extends 'index.html' %}
{% load custom_filters %}
{% block content %}
<div class="main-panel">
    <div class="content-wrapper">
      <div class="row">
        <div class="col-sm-12">
          <div class="home-tab">
            <div class="tab-content tab-content-basic">
              <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview">
                <div class="row">
                  <div class="col-sm-12">
                    <div class="statistics-details d-flex align-items-center justify-content-between">
                      <div class="d-none d-md-block">
                        <div class="card">
                          <div class="card-header">
                            <h3 class="card-title">ORDERS</h3>
                          </div>
                          <div class="card-body">
                            <h3><span>{{total_order}}</span></h3>
                            <p class="{% if order_rate > 0 %}text-success d-flex{% elif order_rate < 0 %}text-danger d-flex{% else %}d-flex{% endif %}">
                              <i class="{% if order_rate > 0 %}mdi mdi-menu-up{% elif order_rate < 0 %}mdi mdi-menu-down{% endif %}"></i>
                              <span>{% if order_rate > 0 %}  {% elif order_rate < 0 %}  {% else %} {% endif %} {{ order_rate }}%</span>
                          </p>
                          </div>
                        </div>
                      </div>
                      <div class="d-none d-md-block">
                        <div class="card">
                          <div class="card-header">
                            <h3 class="card-title">INCOME</h3>
                          </div>
                          <div class="card-body">
                            <h3><span>{{total_income|commafy}}</span></h3>
                            <p class="{% if income_rate > 0 %}text-success d-flex{% elif income_rate < 0 %}text-danger d-flex{% else %}d-flex{% endif %}">
                              <i class="{% if income_rate > 0 %}mdi mdi-menu-up{% elif income_rate < 0 %}mdi mdi-menu-down{% endif %}"></i>
                              <span>{% if income_rate > 0 %} {% elif income_rate < 0 %}  {% else %} {% endif %} {{ income_rate|commafy }}</span>
                          </p>
                          </div>
                        </div>
                      </div>

                      <div class="d-none d-md-block">
                        <div class="card">
                          <div class="card-header">
                            <h3 class="card-title">PURCHASE</h3>
                          </div>
                          <div class="card-body">
                            <h3><span>{{ purchases|commafy }}</span></h3>
                            <p class="{% if purchases_rate < 0 %}text-success d-flex{% elif purchases_rate > 0 %}text-danger d-flex{% else %}d-flex{% endif %}">
                              <i class="{% if purchases_rate > 0 %}mdi mdi-menu-up{% elif purchases_rate < 0 %}mdi mdi-menu-down{% endif %}"></i>

                              <span>{% if today_purchase > yesterday_purchase %} - {% elif today_purchase < yesterday_purchase %} + {% endif %} {{ purchases_rate| commafy }}</span>

                              <!-- <span>{% if purchases_rate > 0 %} + {% elif purchases_rate < 0 %} - {% else %} {% endif %} {{purchases_rate}}</span> -->

                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-lg-8 d-flex flex-column">
                    <div class="row flex-grow">
                      <div class="col-12 col-lg-4 col-lg-12 grid-margin stretch-card">
                        <div class="card card-rounded">
                          <div class="card-body">
                            <div class="d-sm-flex justify-content-between align-items-start">
                              <div>
                              <h4 class="card-title card-title-dash">Weekly sales comparison</h4>
                              <h5 class="card-subtitle card-subtitle-dash"></h5>
                              </div>
                              <div id="performance-line-legend"></div>
                            </div>
                            <div class="chartjs-wrapper mt-5">
                              <canvas id="performaneLine"></canvas>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
              <!-- <div class="col-lg-4 d-flex flex-column">
                      <div class="row flex-grow">
                      <div class="col-12 grid-margin stretch-card">
                        <div class="card card-rounded">
                          <div class="card-body">
                            <div class="row">
                              <div class="col-lg-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                  <h4 class="card-title card-title-dash">Category By Amount</h4>
                                </div>
                                <canvas class="my-auto" id="doughnutChart" height="200"></canvas>
                                <div id="doughnut-chart-legend" class="mt-5 text-center"></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
              </div> -->
                </div>
                <div class="row">
                  <div class="col-lg-8 d-flex flex-column">
                    <div class="row flex-grow">
                      <div class="col-12 grid-margin stretch-card">
                        <div class="card card-rounded">
                          <div class="card-body">
                            <div class="d-sm-flex justify-content-between align-items-start">
                              <div>
                                <h4 class="card-title card-title-dash">Market Overview</h4>
                              <p class="card-subtitle card-subtitle-dash">Monthly market review</p>
                              </div>
                              <div>
                                  <div class="dropdown">
                                    <button class="btn btn-secondary dropdown-toggle toggle-dark btn-lg mb-0 me-0"
                                            type="button"
                                            id="dropdownMenuButton2"
                                            data-bs-toggle="dropdown"
                                            aria-haspopup="true"
                                            aria-expanded="false">

                                        {{ selected_year }}
                                    </button>

                                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton2">
                                      <h6 class="dropdown-header">Select Year</h6>

                                      {% for d in available_years %}
                                        <a class="dropdown-item {% if d.year == selected_year %}active{% endif %}"
                                          href="?year={{ d.year }}">
                                            {{ d.year }}
                                        </a>
                                      {% endfor %}
                                    </div>
                                  </div>
                              </div>
                            </div>
                            <div class="d-sm-flex align-items-center mt-1 justify-content-between">
                              <div class="d-sm-flex align-items-center mt-4 justify-content-between"><h2 class="me-2 fw-bold"></h2><h4 class="me-2"></h4><h4 class="{% if p < 0 %} text-danger {% else %} text-success {% endif %}"></h4></div>
                              <div class="me-3"><div id="marketing-overview-legend"></div></div>
                            </div>
                            <div class="chartjs-bar-wrapper mt-3">
                              <canvas id="marketingOverview" width="400" height="200"></canvas>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
</div>
<!-- Financial Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="post" action="{% url 'financial_report' %}">
      {% csrf_token %}
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Generate Financial Report</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <!-- Filter Type -->
          <div class="mb-3">
            <label class="form-label">Filter Type</label>
            <select class="form-select" name="filter_type" id="filter_type" required>
              <option value="date">Date Range</option>
              <option value="year">Year</option>
            </select>
          </div>

          <!-- Date Range -->
          <div id="dateFields">
            <div class="mb-3">
              <label class="form-label">Start Date</label>
              <input type="date" class="form-control" name="start_date">
            </div>

            <div class="mb-3">
              <label class="form-label">End Date</label>
              <input type="date" class="form-control" name="end_date">
            </div>
          </div>

          <!-- Year -->
          <div class="mb-3 d-none" id="yearField">
            <label class="form-label">Select Year</label>
            <input type="number" class="form-control" name="year" min="2000" max="2100">
          </div>

          <!-- Format -->
          <div class="mb-3">
            <label class="form-label">Export Format</label>
            <select class="form-select" name="format" required>
              <option value="excel">Excel</option>
              <option value="pdf">PDF</option>
            </select>
          </div>

        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Download</button>
        </div>

      </div>
    </form>
  </div>
</div>

<script>
document.getElementById('filter_type').addEventListener('change', function() {
    if (this.value === 'year') {
        document.getElementById('yearField').classList.remove('d-none');
        document.getElementById('dateFields').classList.add('d-none');
    } else {
        document.getElementById('yearField').classList.add('d-none');
        document.getElementById('dateFields').classList.remove('d-none');
    }
});
</script>


<!-- Modal -->
<div class="modal fade" id="unsoldStockModal" tabindex="-1" aria-labelledby="unsoldStockModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="get" action="{% url 'unsold_stock_report' %}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="unsoldStockModalLabel">Generate Unsold Stock Report</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <p>This will generate a PDF report of all unsold stock with COGS.</p>
          <label>Export Format:</label>
          <select name="format" class="form-select" required>
            <option value="pdf">PDF</option>
          </select>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Download Report</button>
        </div>
      </div>
    </form>
  </div>
</div>

 <script>
    // -----------------------------
    // PARSE DATA FROM DJANGO CONTEXT
    // -----------------------------
    var purchase_totals = JSON.parse('{{ purchase_totals|escapejs }}');
    var sales_totals = JSON.parse('{{ sales_totals|escapejs }}');
    var months = JSON.parse('{{ months|escapejs }}');

    var this_week_totals = JSON.parse('{{ this_week_totals|escapejs }}');
    var last_week_totals = JSON.parse('{{ last_week_totals|escapejs }}');
    var day_labels = JSON.parse('{{ day_labels|escapejs }}');

    // Top products
    var daily_top_product_labels = JSON.parse('{{ top_product_labels|escapejs }}');
    var daily_top_product_totals = JSON.parse('{{ top_product_totals|escapejs }}');

    var weekly_top_product_labels = JSON.parse('{{ weekly_top_product_labels|escapejs }}');
    var weekly_top_product_totals = JSON.parse('{{ weekly_top_product_totals|escapejs }}');

    var monthly_top_product_labels = JSON.parse('{{ monthly_top_product_labels|escapejs }}');
    var monthly_top_product_totals = JSON.parse('{{ monthly_top_product_totals|escapejs }}');

    console.log("Purchase Totals:", purchase_totals);
    console.log("Sales Totals:", sales_totals);
    console.log("Months:", months);
    console.log("This Week Totals:", this_week_totals);
    console.log("Last Week Totals:", last_week_totals);
    console.log("Day Labels:", day_labels);
    console.log("Daily Top Products:", daily_top_product_labels, daily_top_product_totals);
    console.log("Weekly Top Products:", weekly_top_product_labels, weekly_top_product_totals);
    console.log("Monthly Top Products:", monthly_top_product_labels, monthly_top_product_totals);
</script>

{% endblock %}